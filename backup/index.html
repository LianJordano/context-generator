<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Estructura de Directorios</title>
    
    <!-- jQuery y Select2 desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9ff;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #5a67d8;
            background-color: #edf2ff;
        }
        
        .upload-area.dragover {
            border-color: #38b2ac;
            background-color: #e6fffa;
            border-style: solid;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #667eea;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .file-selector {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f7fafc;
        }
        
        .file-selector h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .file-selector-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .file-stats-summary {
            background-color: #e6f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .file-stats-summary strong {
            color: #667eea;
        }
        
        .search-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background-color: #fff8f0;
        }
        
        .search-section h4 {
            color: #d69e2e;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .search-result-item {
            background: white;
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .search-result-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .search-match-line {
            background: #fff3cd;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .search-highlight {
            background: #ffc107;
            color: #000;
            font-weight: bold;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        .unify-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f0f8f0;
        }
        
        .unify-section h4 {
            color: #38a169;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }
        
        .btn:hover {
            background: #5a67d8;
        }
        
        .btn-copy {
            background: #38b2ac;
            font-size: 12px;
            padding: 8px 16px;
        }
        
        .btn-copy:hover {
            background: #319795;
        }
        
        .btn-secondary {
            background: #718096;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .btn-success {
            background: #38a169;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 2px solid #667eea;
        }
        
        .section-header h3, .section-header h4 {
            color: #667eea;
            margin: 0;
        }
        
        .tree-output {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
            position: relative;
        }
        
        .unified-output {
            background-color: #1a202c;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 800px;
            overflow-y: auto;
            margin-bottom: 20px;
            position: relative;
        }
        
        .file-section {
            margin-bottom: 30px;
        }
        
        .message {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .error { background-color: #ff6b6b; color: white; }
        .success { background-color: #51cf66; color: white; }
        .info { background-color: #54a0ff; color: white; }
        
        .copy-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #38b2ac;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(300px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .copy-feedback.show {
            transform: translateX(0);
        }
        
        #folderInput { display: none; }

        .file-stats {
            background-color: #2b6cb0;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 10px;
        }
        
        /* Estilos personalizados para Select2 */
        .select2-container {
            width: 100% !important;
        }
        
        .select2-container--default .select2-selection--multiple {
            min-height: 120px;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 5px;
        }
        
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #667eea;
            border: 1px solid #667eea;
            color: white;
            padding: 3px 8px;
            margin: 2px;
            border-radius: 4px;
        }
        
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white;
            margin-right: 5px;
        }
        
        .select2-dropdown {
            border: 2px solid #667eea;
        }
        
        .select2-results__option--highlighted {
            background-color: #667eea !important;
        }
        
        .file-type-icon {
            margin-right: 5px;
        }
        
        .folder-group {
            font-weight: bold;
            color: #667eea;
            background-color: #f8f9ff;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ Explorador de Directorios</h1>
            <p>Selecciona una carpeta para ver su estructura</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div>Haz clic aqu√≠ para seleccionar una carpeta</div>
                <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    O puedes arrastrar y soltar una carpeta
                </div>
            </div>
            
            <input type="file" id="folderInput" webkitdirectory multiple>
            
            <div>
                <label>Carpetas a ignorar:</label>
                <input type="text" id="ignoredFolders" 
                       value=".git, node_modules, .vscode, .idea, vendor, dist, build"
                       placeholder="Separadas por comas">
                
                <label>Archivos a ignorar:</label>
                <input type="text" id="ignoredFiles" 
                       value=".DS_Store, .gitignore, Thumbs.db, package-lock.json"
                       placeholder="Separados por comas">

                <div style="margin-bottom: 15px;">
                    <label>
                        <input type="checkbox" id="onlyFolders"> Mostrar solo estructura de carpetas (ignorar todos los archivos)
                    </label>
                </div>
                
                <label>Archivos espec√≠ficos para mostrar contenido:</label>
                <input type="text" id="specificFiles" 
                       placeholder="Ej: package.json, README.md, config.js (separados por comas)">
                <small style="color: #666; display: block; margin-top: 5px;">
                    üí° Estos archivos mostrar√°n su contenido completo despu√©s de la estructura
                </small>
            </div>
            
            <!-- B√∫squeda de contenido -->
            <div class="search-section" id="searchSection" style="display: none;">
                <h4>üîç B√∫squeda de Contenido</h4>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="searchInput" placeholder="Buscar palabras o frases en los archivos..." style="margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <label>
                            <input type="checkbox" id="caseSensitive"> Sensible a may√∫sculas
                        </label>
                        <label>
                            <input type="checkbox" id="wholeWord"> Palabra completa
                        </label>
                        <label>
                            <input type="checkbox" id="regexSearch"> Expresi√≥n regular
                        </label>
                    </div>
                    <button class="btn" onclick="searchInFiles()">üîç Buscar</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">üóëÔ∏è Limpiar B√∫squeda</button>
                </div>
                
                <div id="searchResults" style="display: none;">
                    <div class="file-stats-summary">
                        <strong>Resultados:</strong> <span id="searchResultsCount">0</span> archivos encontrados |
                        <strong>Coincidencias:</strong> <span id="matchesCount">0</span> total
                    </div>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-secondary" onclick="selectSearchResults()">‚úì Seleccionar Resultados</button>
                        <button class="btn btn-success" onclick="generateSearchUnifiedDocument()">üìã Unificar Solo Resultados</button>
                    </div>
                    <div id="searchResultsList" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>

            <!-- Selector de archivos mejorado con Select2 -->
            <div class="file-selector" id="fileSelectorSection" style="display: none;">
                <h4>üìÑ Seleccionar archivos para unificar</h4>
                
                <div class="file-stats-summary" id="fileStatsSummary">
                    <strong>Archivos disponibles:</strong> <span id="totalFiles">0</span> |
                    <strong>En carpetas:</strong> <span id="totalFolders">0</span> |
                    <strong>Tipos de archivo:</strong> <span id="fileTypes">-</span>
                </div>
                
                <select id="fileSelector" multiple="multiple">
                </select>
                
                <div class="file-selector-controls">
                    <button class="btn btn-secondary" onclick="selectAllFiles()">‚úì Seleccionar Todo</button>
                    <button class="btn btn-secondary" onclick="clearFileSelection()">‚úó Limpiar Selecci√≥n</button>
                    <button class="btn btn-secondary" onclick="selectByExtension()">üéØ Seleccionar por Extensi√≥n</button>
                    <button class="btn btn-success" onclick="generateUnifiedDocument()">üìã Generar Documento Unificado</button>
                </div>
            </div>
            
            <!-- Secci√≥n de unificaci√≥n -->
            <div class="unify-section" id="unifySection" style="display: none;">
                <h4>üìã Documento Unificado</h4>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="copyUnifiedToClipboard()">üìã Copiar Documento Unificado</button>
                    <button class="btn btn-secondary" onclick="downloadUnifiedDocument()">üíæ Descargar como TXT</button>
                </div>
                <div id="unifiedContent" class="unified-output"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="clearResults()">üóëÔ∏è Limpiar</button>
                <button class="btn" onclick="copyAllToClipboard()">üìã Copiar Todo</button>
                <button class="btn btn-secondary" onclick="toggleSearchSection()">üîç Mostrar/Ocultar B√∫squeda</button>
            </div>
            
            <div id="messages"></div>
            <div id="results"></div>
        </div>
    </div>

    <!-- Feedback de copia -->
    <div id="copyFeedback" class="copy-feedback">
        ‚úÖ Copiado al portapapeles
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
const folderInput = document.getElementById('folderInput');
const messagesDiv = document.getElementById('messages');
const resultsDiv = document.getElementById('results');
const copyFeedback = document.getElementById('copyFeedback');
const fileSelectorSection = document.getElementById('fileSelectorSection');
const unifySection = document.getElementById('unifySection');
const unifiedContent = document.getElementById('unifiedContent');
const MAX_DISPLAY_SIZE = 1000000; // 1MB L√≠mite para mostrar contenido de archivo

let currentTree = '';
let currentContents = {};
let allFiles = {}; // Almacenar todos los archivos procesados con estructura completa
let fileStructureData = {}; // Para almacenar la estructura completa
let allFileContents = {}; // Para almacenar el contenido de TODOS los archivos de texto
let searchResults = {}; // Para almacenar resultados de b√∫squeda

// Eventos de clic y arrastrar
uploadArea.addEventListener('click', () => folderInput.click());

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const items = e.dataTransfer.items;
    if (items) {
        for (let i = 0; i < items.length; i++) {
            const item = items[i].webkitGetAsEntry();
            if (item && item.isDirectory) {
                processDirectory(item);
                break;
            }
        }
    }
});

folderInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        processFiles(e.target.files);
    }
});

function showMessage(text, type = 'info') {
    messagesDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
}

function showCopyFeedback() {
    copyFeedback.classList.add('show');
    setTimeout(() => {
        copyFeedback.classList.remove('show');
    }, 2000);
}

function getFileIcon(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();
    const icons = {
        // C√≥digo
        'js': 'üü®', 'jsx': 'üü®', 'ts': 'üî∑', 'tsx': 'üî∑',
        'html': 'üüß', 'htm': 'üüß', 'css': 'üé®', 'scss': 'üé®', 'sass': 'üé®',
        'json': 'üìã', 'xml': 'üìã', 'yaml': 'üìã', 'yml': 'üìã',
        'php': 'üü£', 'py': 'üêç', 'java': '‚òï', 'c': '‚öôÔ∏è', 'cpp': '‚öôÔ∏è',
        'cs': 'üíô', 'rb': 'üíé', 'go': 'üêπ', 'rs': 'ü¶Ä',
        // Documentos
        'md': 'üìù', 'txt': 'üìÑ', 'pdf': 'üìï',
        'doc': 'üìò', 'docx': 'üìò', 'rtf': 'üìÑ',
        // Configuraci√≥n
        'env': 'üîß', 'config': 'üîß', 'conf': 'üîß', 'ini': 'üîß',
        'dockerfile': 'üê≥', 'gitignore': 'üìã',
        // Por defecto
        'default': 'üìÑ'
    };
    return icons[extension] || icons['default'];
}

function processFiles(files) {
    showMessage('üìÇ Procesando archivos...', 'info');
    
    const fileStructure = {};
    const ignoredFolders = getIgnoredItems('ignoredFolders');
    const ignoredFiles = getIgnoredItems('ignoredFiles');
    const specificFiles = getIgnoredItems('specificFiles');
    const onlyFolders = document.getElementById('onlyFolders').checked;
    const fileContents = {};
    allFiles = {}; // Reset
    fileStructureData = {}; // Reset
    
    // Organizar archivos por estructura de carpetas
    for (let file of files) {
        const path = file.webkitRelativePath;
        const parts = path.split('/');
        const fileName = parts[parts.length - 1];
        
        // Verificar si alguna parte del path est√° en la lista de ignorados
        if (shouldIgnore(parts, ignoredFolders, ignoredFiles)) {
            continue;
        }

        if (!onlyFolders) {
            // Guardar TODOS los archivos de texto para el selector
            if (isTextFile(fileName)) {
                allFiles[path] = {
                    file: file,
                    name: fileName,
                    path: path,
                    folder: parts.slice(0, -1).join('/') || 'ra√≠z',
                    extension: fileName.split('.').pop().toLowerCase() || 'sin extensi√≥n',
                    icon: getFileIcon(fileName)
                };
            }
            
            // Guardar contenido de archivos espec√≠ficos
            if (specificFiles.length === 0 || specificFiles.some(sf => fileName.includes(sf) || sf.includes(fileName))) {
                fileContents[path] = file;
            }
        }
        
        let current = fileStructure;
        for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (!current[part]) {
                if (i === parts.length - 1 && !onlyFolders) {
                    current[part] = null; // Es un archivo
                } else {
                    current[part] = {}; // Es una carpeta
                }
            }
            if (i < parts.length - 1) {
                current = current[part];
            }
        }
    }
    
    fileStructureData = fileStructure;
    
    if (Object.keys(fileStructure).length === 0) {
        showMessage('‚ùå No se encontraron archivos v√°lidos o todos fueron filtrados', 'error');
        return;
    }
    
    const tree = generateTree(fileStructure);
    currentTree = tree;
    
    // Llenar el selector de archivos mejorado
    populateFileSelector();
    
    // Cargar contenido de TODOS los archivos de texto para b√∫squeda - **ELIMINADO DE AQU√ç PARA MEJORAR RENDIMIENTO**
    
    // Leer contenido de archivos espec√≠ficos
    if (Object.keys(fileContents).length > 0) {
        readFileContents(fileContents).then(contents => {
            currentContents = contents;
            showTreeWithContents(tree, contents);
            showMessage('‚úÖ Estructura y contenidos generados exitosamente', 'success');
        });
    } else {
        showTree(tree);
        showMessage('‚úÖ Estructura generada exitosamente', 'success');
    }
}

function isTextFile(fileName) {
    // Lista expandida de extensiones de archivos de texto
    const textExtensions = [
        'txt', 'md', 'js', 'jsx', 'ts', 'tsx', 'html', 'htm', 'css', 'scss', 'sass', 'less',
        'json', 'xml', 'yaml', 'yml', 'php', 'py', 'java', 'c', 'cpp', 'h', 'hpp',
        'cs', 'rb', 'go', 'rs', 'swift', 'kt', 'scala', 'sh', 'bash', 'ps1',
        'sql', 'r', 'matlab', 'pl', 'lua', 'vim', 'vue', 'svelte', 'astro',
        'dockerfile', 'makefile', 'cmake', 'gradle', 'properties', 'ini', 'cfg', 'conf',
        'log', 'env', 'example', 'sample', 'template', 'proto', 'graphql', 'gql',
        'toml', 'lock', 'ignore', 'editorconfig', 'eslintrc', 'prettierrc', 'babelrc',
        'tsconfig', 'jsconfig', 'webpack', 'rollup', 'vite', 'config'
    ];
    
    const lowerFileName = fileName.toLowerCase();
    
    // Archivos sin extensi√≥n pero que son de texto comunes
    const textFilesNoExt = [
        'readme', 'license', 'changelog', 'dockerfile', 'makefile', 
        'gitignore', 'gitconfig', 'procfile', 'gemfile', 'rakefile',
        'requirements', 'pipfile', 'poetry', 'composer', 'package'
    ];
    
    // Verificar archivos sin extensi√≥n
    if (!fileName.includes('.')) {
        return textFilesNoExt.some(name => lowerFileName.includes(name));
    }
    
    // Obtener extensi√≥n
    const parts = fileName.split('.');
    const extension = parts[parts.length - 1].toLowerCase();
    
    // Verificar extensi√≥n o nombre completo
    return textExtensions.includes(extension) || 
           textFilesNoExt.some(name => lowerFileName.includes(name)) ||
           lowerFileName.startsWith('.'); // Archivos de configuraci√≥n que empiezan con punto
}

function populateFileSelector() {
    console.log(`Archivos encontrados para selector: ${Object.keys(allFiles).length}`);
    
    // Destruir instancia anterior de Select2 si existe
    if ($('#fileSelector').hasClass('select2-hidden-accessible')) {
        $('#fileSelector').select2('destroy');
    }
    
    $('#fileSelector').empty();
    
    if (Object.keys(allFiles).length === 0) {
        console.log('No hay archivos para mostrar en el selector');
        fileSelectorSection.style.display = 'none';
        document.getElementById('searchSection').style.display = 'none';
        return;
    }
    
    // Organizar archivos por carpetas
    const filesByFolder = {};
    const extensionCount = {};
    
    Object.values(allFiles).forEach(fileData => {
        const folder = fileData.folder;
        if (!filesByFolder[folder]) {
            filesByFolder[folder] = [];
        }
        filesByFolder[folder].push(fileData);
        
        // Contar extensiones
        const ext = fileData.extension;
        extensionCount[ext] = (extensionCount[ext] || 0) + 1;
    });
    
    // Actualizar estad√≠sticas
    const totalFiles = Object.keys(allFiles).length;
    const totalFolders = Object.keys(filesByFolder).length;
    const fileTypes = Object.keys(extensionCount).slice(0, 5).join(', ');
    
    document.getElementById('totalFiles').textContent = totalFiles;
    document.getElementById('totalFolders').textContent = totalFolders;
    document.getElementById('fileTypes').textContent = fileTypes;
    
    // Crear grupos por carpeta
    const sortedFolders = Object.keys(filesByFolder).sort();
    
    sortedFolders.forEach(folder => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = `üìÅ ${folder}`;
        
        const sortedFiles = filesByFolder[folder].sort((a, b) => a.name.localeCompare(b.name));
        
        sortedFiles.forEach(fileData => {
            const option = document.createElement('option');
            option.value = fileData.path;
            option.textContent = `${fileData.icon} ${fileData.name}`;
            option.setAttribute('data-folder', folder);
            option.setAttribute('data-extension', fileData.extension);
            optgroup.appendChild(option);
        });
        
        document.getElementById('fileSelector').appendChild(optgroup);
    });
    
    // Inicializar Select2 con configuraci√≥n personalizada
    $('#fileSelector').select2({
        placeholder: "Busca y selecciona archivos...",
        allowClear: true,
        width: '100%',
        templateResult: function(option) {
            if (!option.id) return option.text;
            
            const $option = $(option.element);
            const folder = $option.data('folder');
            const extension = $option.data('extension');
            
            return $(`
                <div>
                    <span style="margin-right: 8px;">${option.text}</span>
                    <small style="color: #666; font-size: 0.85em;">
                        [${extension}] en ${folder}
                    </small>
                </div>
            `);
        },
        templateSelection: function(option) {
            if (!option.id) return option.text;
            return option.text;
        }
    });
    
    fileSelectorSection.style.display = 'block';
    console.log('Selector de archivos mostrado con Select2');
    
    // Mostrar secci√≥n de b√∫squeda SIEMPRE que hay archivos
    const searchSection = document.getElementById('searchSection');
    if (searchSection && Object.keys(allFiles).length > 0) {
        searchSection.style.display = 'block';
        console.log('Secci√≥n de b√∫squeda mostrada');
    } else {
        console.log('No se pudo mostrar la secci√≥n de b√∫squeda. Archivos:', Object.keys(allFiles).length);
    }
}

function selectAllFiles() {
    $('#fileSelector option').prop('selected', true);
    $('#fileSelector').trigger('change');
}

function clearFileSelection() {
    $('#fileSelector').val(null).trigger('change');
    unifySection.style.display = 'none';
}

function selectByExtension() {
    const extensions = prompt('Ingresa las extensiones separadas por comas (ej: js,css,html):', 'js,css,html');
    if (!extensions) return;
    
    const extList = extensions.split(',').map(ext => ext.trim().toLowerCase());
    
    $('#fileSelector option').each(function() {
        const $option = $(this);
        const extension = $option.data('extension');
        if (extList.includes(extension)) {
            $option.prop('selected', true);
        }
    });
    
    $('#fileSelector').trigger('change');
    showMessage(`‚úÖ Seleccionados archivos con extensiones: ${extList.join(', ')}`, 'success');
}

// Funci√≥n para cargar el contenido de todos los archivos de texto
async function loadAllFileContents() {
    showMessage('üìñ Cargando contenido de archivos para b√∫squeda...', 'info');
    allFileContents = {};
    
    const totalFiles = Object.keys(allFiles).length;
    const allPromises = [];
    
    // Para no sobrecargar con mensajes, actualizamos en lotes
    let loadedCount = 0;
    const updateInterval = Math.max(1, Math.floor(totalFiles / 20)); // Actualizar ~20 veces

    for (const [filePath, fileData] of Object.entries(allFiles)) {
        const promise = fileData.file.text()
            .then(content => {
                allFileContents[filePath] = content;
            })
            .catch(error => {
                console.warn(`Error cargando ${filePath}:`, error);
                allFileContents[filePath] = `Error: ${error.message}`;
            })
            .finally(() => {
                loadedCount++;
                if (loadedCount % updateInterval === 0 || loadedCount === totalFiles) {
                     showMessage(`üìñ Cargados ${loadedCount}/${totalFiles} archivos para b√∫squeda...`, 'info');
                }
            });
        allPromises.push(promise);
    }
    
    await Promise.all(allPromises);
    
    showMessage(`‚úÖ Contenido cargado: ${Object.keys(allFileContents).length} archivos listos para b√∫squeda`, 'success');
}

// Funci√≥n para buscar en archivos
async function searchInFiles() {
    const searchTerm = document.getElementById('searchInput').value.trim();
    if (!searchTerm) {
        showMessage('‚ùå Por favor ingresa un t√©rmino de b√∫squeda', 'error');
        return;
    }
    
    // **CAMBIO CLAVE**: Cargar contenido solo si no ha sido cargado antes
    if (Object.keys(allFileContents).length !== Object.keys(allFiles).length) {
        await loadAllFileContents();
    }
    
    showMessage('üîç Buscando...', 'info');
    
    const caseSensitive = document.getElementById('caseSensitive').checked;
    const wholeWord = document.getElementById('wholeWord').checked;
    const regexSearch = document.getElementById('regexSearch').checked;
    
    let searchRegex;
    try {
        if (regexSearch) {
            searchRegex = new RegExp(searchTerm, caseSensitive ? 'g' : 'gi');
        } else {
            const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const pattern = wholeWord ? `\\b${escapedTerm}\\b` : escapedTerm;
            searchRegex = new RegExp(pattern, caseSensitive ? 'g' : 'gi');
        }
    } catch (error) {
        showMessage('‚ùå Error en la expresi√≥n regular: ' + error.message, 'error');
        return;
    }
    
    searchResults = {};
    let totalMatches = 0;
    
    for (const [filePath, content] of Object.entries(allFileContents)) {
        if (content.startsWith('Error:')) continue;
        
        const lines = content.split('\n');
        const matches = [];
        
        lines.forEach((line, lineNumber) => {
            const lineMatches = [...line.matchAll(searchRegex)];
            if (lineMatches.length > 0) {
                matches.push({
                    lineNumber: lineNumber + 1,
                    line: line.trim(),
                    matchCount: lineMatches.length
                });
                totalMatches += lineMatches.length;
            }
        });
        
        if (matches.length > 0) {
            searchResults[filePath] = {
                matches: matches,
                totalMatches: matches.reduce((sum, match) => sum + match.matchCount, 0),
                fileData: allFiles[filePath]
            };
        }
    }
    
    displaySearchResults(searchTerm, totalMatches);
}

function displaySearchResults(searchTerm, totalMatches) {
    const resultsCount = Object.keys(searchResults).length;
    
    document.getElementById('searchResultsCount').textContent = resultsCount;
    document.getElementById('matchesCount').textContent = totalMatches;
    
    if (resultsCount === 0) {
        document.getElementById('searchResults').style.display = 'block';
        document.getElementById('searchResultsList').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No se encontraron resultados</div>';
        showMessage('üîç No se encontraron coincidencias', 'info');
        return;
    }
    
    let html = '';
    const caseSensitive = document.getElementById('caseSensitive').checked;
    const searchRegex = new RegExp(
        document.getElementById('regexSearch').checked 
            ? searchTerm 
            : searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
        caseSensitive ? 'gi' : 'gi'
    );
    
    Object.entries(searchResults).forEach(([filePath, result]) => {
        const fileName = filePath.split('/').pop();
        const fileIcon = getFileIcon(fileName);
        
        html += `
            <div class="search-result-item">
                <div class="search-result-header">
                    ${fileIcon} ${filePath} 
                    <span style="color: #666; font-size: 0.9em;">(${result.totalMatches} coincidencias)</span>
                </div>
        `;
        
        // Mostrar solo las primeras 5 l√≠neas para evitar sobrecargar la UI
        const matchesToShow = result.matches.slice(0, 5);
        matchesToShow.forEach(match => {
            const highlightedLine = match.line.replace(searchRegex, '<span class="search-highlight">$&</span>');
            html += `
                <div class="search-match-line">
                    <span style="color: #666;">L√≠nea ${match.lineNumber}:</span> ${highlightedLine}
                </div>
            `;
        });
        
        if (result.matches.length > 5) {
            html += `<div style="color: #666; font-size: 0.85em; margin-top: 5px;">... y ${result.matches.length - 5} coincidencias m√°s</div>`;
        }
        
        html += '</div>';
    });
    
    document.getElementById('searchResultsList').innerHTML = html;
    document.getElementById('searchResults').style.display = 'block';
    
    showMessage(`‚úÖ Encontrados ${resultsCount} archivos con ${totalMatches} coincidencias`, 'success');
}

function selectSearchResults() {
    const resultPaths = Object.keys(searchResults);
    
    // Limpiar selecci√≥n actual
    $('#fileSelector').val(null).trigger('change');
    
    // Seleccionar archivos de los resultados
    $('#fileSelector option').each(function() {
        const $option = $(this);
        if (resultPaths.includes($option.val())) {
            $option.prop('selected', true);
        }
    });
    
    $('#fileSelector').trigger('change');
    showMessage(`‚úÖ Seleccionados ${resultPaths.length} archivos de los resultados de b√∫squeda`, 'success');
}

async function generateSearchUnifiedDocument() {
    if (Object.keys(searchResults).length === 0) {
        showMessage('‚ùå No hay resultados de b√∫squeda para unificar', 'error');
        return;
    }
    
    const searchTerm = document.getElementById('searchInput').value.trim();
    showMessage('üìù Generando documento unificado de resultados de b√∫squeda...', 'info');
    
    try {
        let unifiedText = `DOCUMENTO UNIFICADO - RESULTADOS DE B√öSQUEDA\n`;
        unifiedText += `T√©rmino buscado: "${searchTerm}"\n`;
        unifiedText += `Generado el: ${new Date().toLocaleString()}\n`;
        unifiedText += `Archivos encontrados: ${Object.keys(searchResults).length}\n`;
        unifiedText += `Total de coincidencias: ${Object.values(searchResults).reduce((sum, r) => sum + r.totalMatches, 0)}\n`;
        unifiedText += `${'='.repeat(80)}\n\n`;
        
        let totalCharacters = 0;
        let totalLines = 0;
        
        for (const [filePath, result] of Object.entries(searchResults)) {
            const content = allFileContents[filePath];
            const lines = content.split('\n').length;
            totalCharacters += content.length;
            totalLines += lines;
            
            unifiedText += `${result.fileData.icon} ARCHIVO: ${filePath}\n`;
            unifiedText += `üìÅ Carpeta: ${result.fileData.folder}\n`;
            unifiedText += `üéØ Coincidencias encontradas: ${result.totalMatches}\n`;
            unifiedText += `üìä Tama√±o: ${content.length} caracteres | L√≠neas: ${lines}\n`;
            unifiedText += `${'-'.repeat(filePath.length + 80)}\n`;
            unifiedText += content + '\n\n';
            unifiedText += `${'='.repeat(80)}\n\n`;
        }
        
        // A√±adir estad√≠sticas
        unifiedText += `üìä ESTAD√çSTICAS DE B√öSQUEDA\n`;
        unifiedText += `${'='.repeat(40)}\n`;
        unifiedText += `üîç T√©rmino buscado: "${searchTerm}"\n`;
        unifiedText += `üìÑ Archivos con coincidencias: ${Object.keys(searchResults).length}\n`;
        unifiedText += `üéØ Total de coincidencias: ${Object.values(searchResults).reduce((sum, r) => sum + r.totalMatches, 0)}\n`;
        unifiedText += `üìù Total de caracteres: ${totalCharacters.toLocaleString()}\n`;
        unifiedText += `üìè Total de l√≠neas: ${totalLines.toLocaleString()}\n`;
        unifiedText += `üíæ Tama√±o aproximado: ${(totalCharacters / 1024).toFixed(2)} KB\n`;
        
        // Mostrar el contenido unificado
        const statsHtml = `
            <div class="file-stats">
                üîç "${searchTerm}" | ${Object.keys(searchResults).length} archivos | ${Object.values(searchResults).reduce((sum, r) => sum + r.totalMatches, 0)} coincidencias | ${totalCharacters.toLocaleString()} caracteres | ${(totalCharacters / 1024).toFixed(2)} KB
            </div>
        `;
        
        unifiedContent.innerHTML = statsHtml + escapeHtml(unifiedText);
        unifySection.style.display = 'block';
        
        // Guardar para funciones de copia/descarga
        window.currentUnifiedDocument = unifiedText;
        
        showMessage('‚úÖ Documento unificado de b√∫squeda generado exitosamente', 'success');
        
        // Scroll hacia la secci√≥n unificada
        unifySection.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        showMessage('‚ùå Error al generar el documento unificado de b√∫squeda: ' + error.message, 'error');
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').style.display = 'none';
    searchResults = {};
    showMessage('üóëÔ∏è B√∫squeda limpiada', 'info');
}

// Funci√≥n para mostrar/ocultar manualmente la secci√≥n de b√∫squeda
function toggleSearchSection() {
    const searchSection = document.getElementById('searchSection');
    if (searchSection.style.display === 'none') {
        searchSection.style.display = 'block';
        showMessage('üîç Secci√≥n de b√∫squeda activada', 'success');
    } else {
        searchSection.style.display = 'none';
        showMessage('üîç Secci√≥n de b√∫squeda oculta', 'info');
    }
}

async function generateUnifiedDocument() {
    const selectedFiles = $('#fileSelector').val() || [];
    
    if (selectedFiles.length === 0) {
        showMessage('‚ùå Por favor selecciona al menos un archivo', 'error');
        return;
    }
    
    showMessage('üìù Generando documento unificado...', 'info');
    
    try {
        let unifiedText = `DOCUMENTO UNIFICADO\n`;
        unifiedText += `Generado el: ${new Date().toLocaleString()}\n`;
        unifiedText += `Total de archivos: ${selectedFiles.length}\n`;
        unifiedText += `${'='.repeat(80)}\n\n`;
        
        let totalCharacters = 0;
        let totalLines = 0;
        const processedFolders = new Set();
        
        for (const filePath of selectedFiles) {
            const fileData = allFiles[filePath];
            if (fileData && fileData.file) {
                try {
                    const content = await fileData.file.text();
                    const lines = content.split('\n').length;
                    totalCharacters += content.length;
                    totalLines += lines;
                    processedFolders.add(fileData.folder);
                    
                    unifiedText += `${fileData.icon} ARCHIVO: ${filePath}\n`;
                    unifiedText += `üìÅ Carpeta: ${fileData.folder}\n`;
                    unifiedText += `üìä Tama√±o: ${content.length} caracteres | L√≠neas: ${lines} | Extensi√≥n: .${fileData.extension}\n`;
                    unifiedText += `${'-'.repeat(filePath.length + 80)}\n`;
                    unifiedText += content + '\n\n';
                    unifiedText += `${'='.repeat(80)}\n\n`;
                } catch (error) {
                    unifiedText += `${fileData.icon} ARCHIVO: ${filePath}\n`;
                    unifiedText += `‚ùå Error al leer el archivo: ${error.message}\n`;
                    unifiedText += `${'='.repeat(80)}\n\n`;
                }
            }
        }
        
        // A√±adir estad√≠sticas detalladas al final
        unifiedText += `üìä ESTAD√çSTICAS DEL DOCUMENTO UNIFICADO\n`;
        unifiedText += `${'='.repeat(50)}\n`;
        unifiedText += `üìÑ Archivos procesados: ${selectedFiles.length}\n`;
        unifiedText += `üìÅ Carpetas involucradas: ${processedFolders.size} (${Array.from(processedFolders).join(', ')})\n`;
        unifiedText += `üìù Total de caracteres: ${totalCharacters.toLocaleString()}\n`;
        unifiedText += `üìè Total de l√≠neas: ${totalLines.toLocaleString()}\n`;
        unifiedText += `üíæ Tama√±o aproximado: ${(totalCharacters / 1024 / 1024).toFixed(2)} MB\n`;
        unifiedText += `üïí Generado: ${new Date().toLocaleString()}\n`;
        
        // Mostrar el contenido unificado
        const statsHtml = `
            <div class="file-stats">
                üìä ${selectedFiles.length} archivos | ${processedFolders.size} carpetas | ${totalCharacters.toLocaleString()} caracteres | ${totalLines.toLocaleString()} l√≠neas | ${(totalCharacters / 1024 / 1024).toFixed(2)} MB
            </div>
        `;
        
        unifiedContent.innerHTML = statsHtml + escapeHtml(unifiedText);
        unifySection.style.display = 'block';
        
        // Guardar para funciones de copia/descarga
        window.currentUnifiedDocument = unifiedText;
        
        showMessage('‚úÖ Documento unificado generado exitosamente', 'success');
        
        // Scroll hacia la secci√≥n unificada
        unifySection.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        showMessage('‚ùå Error al generar el documento unificado: ' + error.message, 'error');
    }
}

function copyUnifiedToClipboard() {
    if (!window.currentUnifiedDocument) {
        showMessage('‚ùå No hay documento unificado para copiar', 'error');
        return;
    }
    
    navigator.clipboard.writeText(window.currentUnifiedDocument).then(() => {
        showCopyFeedback();
    }).catch(() => {
        showMessage('‚ùå Error al copiar el documento unificado', 'error');
    });
}

function downloadUnifiedDocument() {
    if (!window.currentUnifiedDocument) {
        showMessage('‚ùå No hay documento unificado para descargar', 'error');
        return;
    }
    
    const blob = new Blob([window.currentUnifiedDocument], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `documento_unificado_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showMessage('üíæ Documento descargado exitosamente', 'success');
}

function processDirectory(directoryEntry) {
    showMessage('üìÇ Procesando directorio...', 'info');
    
    const fileStructure = {};
    const ignoredFolders = getIgnoredItems('ignoredFolders');
    const ignoredFiles = getIgnoredItems('ignoredFiles');
    
    function readDirectory(dirEntry, path = '') {
        return new Promise((resolve) => {
            const dirReader = dirEntry.createReader();
            const entries = [];
            
            function readEntries() {
                dirReader.readEntries((results) => {
                    if (results.length === 0) {
                        resolve(entries);
                    } else {
                        entries.push(...results);
                        readEntries();
                    }
                });
            }
            readEntries();
        });
    }
    
    async function buildStructure(dirEntry, currentPath = '') {
        const entries = await readDirectory(dirEntry);
        const structure = {};
        
        for (let entry of entries) {
            if (ignoredFolders.includes(entry.name) || 
                ignoredFiles.includes(entry.name)) {
                continue;
            }
            
            if (entry.isDirectory) {
                structure[entry.name] = await buildStructure(entry, currentPath + '/' + entry.name);
            } else {
                structure[entry.name] = null;
            }
        }
        
        return structure;
    }
    
    buildStructure(directoryEntry)
        .then(structure => {
            const rootStructure = { [directoryEntry.name]: structure };
            const tree = generateTree(rootStructure);
            currentTree = tree;
            showTree(tree);
            showMessage('‚úÖ Estructura generada exitosamente', 'success');
        })
        .catch(error => {
            showMessage('‚ùå Error al procesar el directorio: ' + error.message, 'error');
        });
}

function getIgnoredItems(inputId) {
    const value = document.getElementById(inputId).value;
    return value.split(',').map(item => item.trim()).filter(item => item.length > 0);
}

function shouldIgnore(pathParts, ignoredFolders, ignoredFiles) {
    for (let part of pathParts) {
        if (ignoredFolders.includes(part) || ignoredFiles.includes(part)) {
            return true;
        }
    }
    return false;
}

function generateTree(structure, prefix = '', isLast = true) {
    let result = '';
    const entries = Object.entries(structure);
    
    entries.forEach(([name, content], index) => {
        const isLastItem = index === entries.length - 1;
        const connector = isLastItem ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
        const nextPrefix = prefix + (isLastItem ? '    ' : '‚îÇ   ');
        
        result += prefix + connector + name;
        
        if (content !== null) {
            result += '/\n';
            result += generateTree(content, nextPrefix, isLastItem);
        } else {
            result += '\n';
        }
    });
    
    return result;
}

function showTree(tree) {
    resultsDiv.innerHTML = `
        <div class="section-header">
            <h3>üìÅ Estructura del Proyecto</h3>
            <button class="btn btn-copy" onclick="copyTreeToClipboard()">üìã Copiar Estructura</button>
        </div>
        <div class="tree-output">${tree}</div>
    `;
}

function showTreeWithContents(tree, contents) {
    let html = `
        <div class="section-header">
            <h3>üìÅ Estructura del Proyecto</h3>
            <button class="btn btn-copy" onclick="copyTreeToClipboard()">üìã Copiar Estructura</button>
        </div>
        <div class="tree-output">${tree}</div>
    `;
    
    if (Object.keys(contents).length > 0) {
        html += `
            <div class="section-header" style="margin-top: 30px;">
                <h3>üìÑ Contenido de Archivos Espec√≠ficos</h3>
            </div>
        `;
        
        Object.entries(contents).forEach(([filePath, content]) => {
            const fileName = filePath.split('/').pop();
            const fileExtension = fileName.split('.').pop().toLowerCase();
            const fileId = filePath.replace(/[^a-zA-Z0-9]/g, '_');
            const fileIcon = getFileIcon(fileName);
            
            html += `
                <div class="file-section">
                    <div class="section-header">
                        <h4>${fileIcon} ${filePath}</h4>
                        <button class="btn btn-copy" onclick="copyFileToClipboard('${fileId}', '${escapeQuotes(filePath)}')">üìã Copiar Archivo</button>
                    </div>
                    <div class="tree-output" id="file_${fileId}" style="background-color: #1a202c;">`;

            if (content.length > MAX_DISPLAY_SIZE) {
                const sizeInMB = (content.length / 1024 / 1024).toFixed(2);
                html += `
                        <div style="color: #ffcc00; margin-bottom: 10px; font-size: 12px;">
                            // ‚ö†Ô∏è Archivo demasiado grande para mostrar (${sizeInMB} MB).
                            // El contenido completo est√° disponible para b√∫squeda y unificaci√≥n.
                        </div>`;
            } else {
                html += `
                        <div style="color: #68d391; margin-bottom: 10px; font-size: 12px;">
                            // Archivo: ${fileName} | Extensi√≥n: ${fileExtension} | Tama√±o: ${content.length} caracteres
                        </div>
                        ${escapeHtml(content)}`;
            }
                        
            html += `
                    </div>
                </div>
            `;
        });
    }
    
    resultsDiv.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeQuotes(text) {
    return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
}

async function readFileContents(fileContents) {
    const contents = {};
    
    for (const [path, file] of Object.entries(fileContents)) {
        try {
            const text = await file.text();
            contents[path] = text;
        } catch (error) {
            contents[path] = `Error al leer el archivo: ${error.message}`;
        }
    }
    
    return contents;
}

function clearResults() {
    resultsDiv.innerHTML = '';
    messagesDiv.innerHTML = '';
    currentTree = '';
    currentContents = {};
    allFiles = {};
    fileStructureData = {};
    allFileContents = {};
    searchResults = {};
    folderInput.value = '';
    
    // Destruir Select2 si existe
    if ($('#fileSelector').hasClass('select2-hidden-accessible')) {
        $('#fileSelector').select2('destroy');
    }
    $('#fileSelector').empty();
    
    fileSelectorSection.style.display = 'none';
    unifySection.style.display = 'none';
    document.getElementById('searchSection').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    window.currentUnifiedDocument = null;
    
    // Limpiar estad√≠sticas
    document.getElementById('totalFiles').textContent = '0';
    document.getElementById('totalFolders').textContent = '0';
    document.getElementById('fileTypes').textContent = '-';
}

// Funci√≥n para copiar solo la estructura del √°rbol
function copyTreeToClipboard() {
    if (!currentTree) {
        showMessage('‚ùå No hay estructura para copiar', 'error');
        return;
    }
    
    navigator.clipboard.writeText(currentTree).then(() => {
        showCopyFeedback();
    }).catch(() => {
        showMessage('‚ùå Error al copiar la estructura', 'error');
    });
}

// Funci√≥n para copiar un archivo espec√≠fico
function copyFileToClipboard(fileId, filePath) {
    const fileContent = currentContents[filePath];
    if (fileContent === undefined) {
         showMessage('‚ùå No se pudo encontrar el contenido del archivo para copiarlo.', 'error');
        return;
    }
    
    const fullContent = `=== ${filePath} ===\n${fileContent}`;
    
    navigator.clipboard.writeText(fullContent).then(() => {
        showCopyFeedback();
    }).catch(() => {
        showMessage('‚ùå Error al copiar el archivo', 'error');
    });
}

// Funci√≥n para copiar todo (estructura + archivos)
function copyAllToClipboard() {
    if (!currentTree) {
        showMessage('‚ùå No hay estructura para copiar', 'error');
        return;
    }
    
    let fullContent = `=== ESTRUCTURA DEL PROYECTO ===\n${currentTree}`;
    
    if (Object.keys(currentContents).length > 0) {
        fullContent += '\n\n=== CONTENIDO DE ARCHIVOS ===\n\n';
        
        Object.entries(currentContents).forEach(([filePath, content]) => {
            const fileIcon = getFileIcon(filePath.split('/').pop());
            fullContent += `${fileIcon} === ${filePath} ===\n`;
            fullContent += '='.repeat(filePath.length + 8) + '\n';
            fullContent += content + '\n\n';
        });
    }
    
    navigator.clipboard.writeText(fullContent).then(() => {
        showCopyFeedback();
    }).catch(() => {
        showMessage('‚ùå Error al copiar al portapapeles', 'error');
    });
}

// Mostrar informaci√≥n inicial
showMessage('üëÜ Haz clic en el √°rea de arriba para seleccionar una carpeta', 'info')
    </script>
</body>
</html>